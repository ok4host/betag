<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO -->
    <title>البحث عن عقارات | بي تاج - شقق وفلل للبيع والإيجار</title>
    <meta name="description" content="ابحث في أكثر من 50,000 عقار في مصر. شقق، فلل، أراضي ومحلات للبيع والإيجار. فلتر متقدم بالسعر والمساحة والموقع.">
    <meta name="robots" content="index, follow">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="البحث عن عقارات | بي تاج">
    <meta property="og:description" content="ابحث في أكثر من 50,000 عقار في مصر">
    <meta property="og:site_name" content="بي تاج">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { font-family: 'Cairo', sans-serif; }

        .filter-chip {
            transition: all 0.2s ease;
        }
        .filter-chip.active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .property-card {
            transition: all 0.3s ease;
        }
        .property-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* Range Slider Styling */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 text-right">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="/" class="flex items-center gap-2">
                <div class="bg-primary-600 p-2 rounded-lg text-white">
                    <i class="fa-solid fa-house text-xl"></i>
                </div>
                <span class="text-2xl font-bold text-primary-900">بي تاج</span>
            </a>

            <nav class="hidden md:flex gap-8 items-center text-gray-600 font-medium">
                <a href="/" class="hover:text-primary-600 transition">الرئيسية</a>
                <a href="/pages/search.html?type=sale" class="hover:text-primary-600 transition">شقق للبيع</a>
                <a href="/pages/search.html?type=rent" class="hover:text-primary-600 transition">شقق للإيجار</a>
            </nav>

            <a href="/pages/add-property.html" class="hidden md:block bg-primary-600 text-white px-5 py-2 rounded-lg hover:bg-primary-700 transition shadow-md">
                أضف عقارك
            </a>

            <button id="mobile-menu-btn" class="md:hidden text-gray-700 text-2xl">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- Search Bar -->
    <div class="bg-white border-b shadow-sm">
        <div class="container mx-auto px-4 py-4">
            <form id="search-form" class="flex flex-col md:flex-row gap-4">
                <div class="flex-1 relative">
                    <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" name="q" id="search-query" placeholder="ابحث بالمنطقة أو الكمبوند..."
                           class="w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary-500 outline-none text-lg">
                </div>
                <button type="button" id="filter-toggle" class="md:hidden flex items-center justify-center gap-2 border-2 border-gray-200 py-3 px-6 rounded-xl font-medium">
                    <i class="fa-solid fa-sliders"></i> الفلاتر
                </button>
                <button type="submit" class="bg-primary-600 text-white py-3 px-8 rounded-xl font-bold hover:bg-primary-700 transition">
                    <i class="fa-solid fa-search ml-2"></i> بحث
                </button>
            </form>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6">
        <div class="flex flex-col lg:flex-row gap-6">

            <!-- Sidebar Filters -->
            <aside id="filters-sidebar" class="hidden lg:block w-full lg:w-80 shrink-0">
                <div class="bg-white rounded-2xl shadow-md p-6 sticky top-24 space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-bold text-gray-900">تصفية النتائج</h2>
                        <button onclick="resetFilters()" class="text-sm text-primary-600 hover:underline">مسح الكل</button>
                    </div>

                    <!-- Type Filter -->
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-3">نوع المعاملة</h3>
                        <div class="flex gap-2">
                            <button type="button" class="filter-chip flex-1 border-2 border-gray-200 py-2 px-4 rounded-lg text-center" data-filter="type" data-value="sale">بيع</button>
                            <button type="button" class="filter-chip flex-1 border-2 border-gray-200 py-2 px-4 rounded-lg text-center" data-filter="type" data-value="rent">إيجار</button>
                        </div>
                    </div>

                    <!-- Property Type -->
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-3">نوع العقار</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button type="button" class="filter-chip border-2 border-gray-200 py-2 px-3 rounded-lg text-sm" data-filter="propertyType" data-value="apartment">شقة</button>
                            <button type="button" class="filter-chip border-2 border-gray-200 py-2 px-3 rounded-lg text-sm" data-filter="propertyType" data-value="villa">فيلا</button>
                            <button type="button" class="filter-chip border-2 border-gray-200 py-2 px-3 rounded-lg text-sm" data-filter="propertyType" data-value="duplex">دوبلكس</button>
                            <button type="button" class="filter-chip border-2 border-gray-200 py-2 px-3 rounded-lg text-sm" data-filter="propertyType" data-value="chalet">شاليه</button>
                            <button type="button" class="filter-chip border-2 border-gray-200 py-2 px-3 rounded-lg text-sm" data-filter="propertyType" data-value="commercial">محل</button>
                            <button type="button" class="filter-chip border-2 border-gray-200 py-2 px-3 rounded-lg text-sm" data-filter="propertyType" data-value="office">مكتب</button>
                        </div>
                    </div>

                    <!-- Price Range -->
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-3">السعر</h3>
                        <div class="space-y-3">
                            <div class="flex gap-2">
                                <input type="number" id="price-min" placeholder="من" class="w-1/2 border-2 border-gray-200 p-2 rounded-lg text-center focus:border-primary-500 outline-none">
                                <input type="number" id="price-max" placeholder="إلى" class="w-1/2 border-2 border-gray-200 p-2 rounded-lg text-center focus:border-primary-500 outline-none">
                            </div>
                            <div class="flex flex-wrap gap-2 text-sm">
                                <button type="button" class="text-primary-600 hover:underline" onclick="setPriceRange(0, 1000000)">أقل من مليون</button>
                                <button type="button" class="text-primary-600 hover:underline" onclick="setPriceRange(1000000, 3000000)">1-3 مليون</button>
                                <button type="button" class="text-primary-600 hover:underline" onclick="setPriceRange(3000000, 10000000)">3-10 مليون</button>
                            </div>
                        </div>
                    </div>

                    <!-- Bedrooms -->
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-3">غرف النوم</h3>
                        <div class="flex gap-2">
                            <button type="button" class="filter-chip flex-1 border-2 border-gray-200 py-2 rounded-lg text-center" data-filter="beds" data-value="1">1</button>
                            <button type="button" class="filter-chip flex-1 border-2 border-gray-200 py-2 rounded-lg text-center" data-filter="beds" data-value="2">2</button>
                            <button type="button" class="filter-chip flex-1 border-2 border-gray-200 py-2 rounded-lg text-center" data-filter="beds" data-value="3">3</button>
                            <button type="button" class="filter-chip flex-1 border-2 border-gray-200 py-2 rounded-lg text-center" data-filter="beds" data-value="4">4+</button>
                        </div>
                    </div>

                    <!-- Area -->
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-3">المساحة (م²)</h3>
                        <div class="flex gap-2">
                            <input type="number" id="area-min" placeholder="من" class="w-1/2 border-2 border-gray-200 p-2 rounded-lg text-center focus:border-primary-500 outline-none">
                            <input type="number" id="area-max" placeholder="إلى" class="w-1/2 border-2 border-gray-200 p-2 rounded-lg text-center focus:border-primary-500 outline-none">
                        </div>
                    </div>

                    <!-- Apply Button -->
                    <button onclick="applyFilters()" class="w-full bg-primary-600 text-white py-3 rounded-xl font-bold hover:bg-primary-700 transition">
                        تطبيق الفلاتر
                    </button>
                </div>
            </aside>

            <!-- Results -->
            <main class="flex-1">
                <!-- Results Header -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900" id="results-title">نتائج البحث</h1>
                        <p class="text-gray-500" id="results-count">جاري البحث...</p>
                    </div>
                    <div class="flex gap-3 items-center">
                        <label class="text-gray-600 text-sm">ترتيب:</label>
                        <select id="sort-select" class="border-2 border-gray-200 py-2 px-4 rounded-lg focus:border-primary-500 outline-none bg-white">
                            <option value="newest">الأحدث</option>
                            <option value="price-asc">السعر: من الأقل</option>
                            <option value="price-desc">السعر: من الأعلى</option>
                            <option value="area-desc">المساحة: من الأكبر</option>
                        </select>
                    </div>
                </div>

                <!-- Active Filters -->
                <div id="active-filters" class="flex flex-wrap gap-2 mb-4 hidden"></div>

                <!-- Results Grid -->
                <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- Properties loaded via JS -->
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="hidden text-center py-16">
                    <i class="fa-solid fa-magnifying-glass text-6xl text-gray-300 mb-4"></i>
                    <h2 class="text-xl font-bold text-gray-800 mb-2">لم نجد نتائج</h2>
                    <p class="text-gray-500 mb-6">جرب تغيير معايير البحث</p>
                    <button onclick="resetFilters()" class="bg-primary-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-primary-700 transition">
                        مسح الفلاتر
                    </button>
                </div>

                <!-- Pagination -->
                <div id="pagination" class="flex justify-center gap-2 mt-8"></div>
            </main>
        </div>
    </div>

    <!-- Mobile Filter Modal -->
    <div id="filter-modal" class="fixed inset-0 bg-black/50 z-50 hidden">
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">الفلاتر</h2>
                <button onclick="closeFilterModal()" class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <!-- Filters content will be cloned here -->
            <div id="mobile-filters-content"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-300 py-8 border-t-4 border-primary-600 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p>جميع الحقوق محفوظة © 2025 بي تاج</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="/js/main.js"></script>
    <script>
        // State
        let filters = {
            q: '',
            type: '',
            propertyType: '',
            beds: '',
            priceMin: 0,
            priceMax: Infinity,
            areaMin: 0,
            areaMax: Infinity,
            location: ''
        };
        let sortBy = 'newest';
        let currentPage = 1;
        const perPage = 9;

        // DOM Ready
        document.addEventListener('DOMContentLoaded', function() {
            parseURLParams();
            initFilterChips();
            initSorting();
            initMobileFilter();
            renderResults();
        });

        // Parse URL parameters
        function parseURLParams() {
            const params = new URLSearchParams(window.location.search);

            if (params.get('type')) {
                filters.type = params.get('type');
                activateChip('type', filters.type);
            }
            if (params.get('property_type')) {
                filters.propertyType = params.get('property_type');
                activateChip('propertyType', filters.propertyType);
            }
            if (params.get('location')) {
                filters.location = params.get('location');
                document.getElementById('search-query').value = filters.location;
            }
            if (params.get('q')) {
                filters.q = params.get('q');
                document.getElementById('search-query').value = filters.q;
            }
        }

        // Filter chips
        function initFilterChips() {
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    const filterName = chip.dataset.filter;
                    const value = chip.dataset.value;

                    // Toggle
                    if (chip.classList.contains('active')) {
                        chip.classList.remove('active');
                        filters[filterName] = '';
                    } else {
                        // Deactivate siblings
                        document.querySelectorAll(`[data-filter="${filterName}"]`).forEach(c => c.classList.remove('active'));
                        chip.classList.add('active');
                        filters[filterName] = value;
                    }

                    renderResults();
                });
            });
        }

        function activateChip(filterName, value) {
            const chip = document.querySelector(`[data-filter="${filterName}"][data-value="${value}"]`);
            if (chip) chip.classList.add('active');
        }

        // Sorting
        function initSorting() {
            document.getElementById('sort-select').addEventListener('change', (e) => {
                sortBy = e.target.value;
                renderResults();
            });
        }

        // Mobile filter
        function initMobileFilter() {
            const toggle = document.getElementById('filter-toggle');
            const modal = document.getElementById('filter-modal');

            toggle?.addEventListener('click', () => {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            });

            modal?.addEventListener('click', (e) => {
                if (e.target === modal) closeFilterModal();
            });
        }

        function closeFilterModal() {
            document.getElementById('filter-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Price range shortcuts
        function setPriceRange(min, max) {
            document.getElementById('price-min').value = min;
            document.getElementById('price-max').value = max || '';
            filters.priceMin = min;
            filters.priceMax = max || Infinity;
        }

        // Apply filters
        function applyFilters() {
            const priceMin = document.getElementById('price-min').value;
            const priceMax = document.getElementById('price-max').value;
            const areaMin = document.getElementById('area-min').value;
            const areaMax = document.getElementById('area-max').value;

            filters.priceMin = priceMin ? parseInt(priceMin) : 0;
            filters.priceMax = priceMax ? parseInt(priceMax) : Infinity;
            filters.areaMin = areaMin ? parseInt(areaMin) : 0;
            filters.areaMax = areaMax ? parseInt(areaMax) : Infinity;

            closeFilterModal();
            renderResults();
        }

        // Reset filters
        function resetFilters() {
            filters = { q: '', type: '', propertyType: '', beds: '', priceMin: 0, priceMax: Infinity, areaMin: 0, areaMax: Infinity, location: '' };
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            document.getElementById('search-query').value = '';
            document.getElementById('price-min').value = '';
            document.getElementById('price-max').value = '';
            document.getElementById('area-min').value = '';
            document.getElementById('area-max').value = '';
            renderResults();
        }

        // Render results
        function renderResults() {
            const grid = document.getElementById('results-grid');
            const emptyState = document.getElementById('empty-state');
            const resultsCount = document.getElementById('results-count');

            // Get all properties
            let properties = window.BeTaj?.properties || [];

            // Apply filters
            properties = properties.filter(p => {
                if (filters.type && p.type !== filters.type) return false;
                if (filters.propertyType && p.propertyType !== filters.propertyType) return false;
                if (filters.beds) {
                    const minBeds = filters.beds === '4' ? 4 : parseInt(filters.beds);
                    if (filters.beds === '4' && p.beds < minBeds) return false;
                    if (filters.beds !== '4' && p.beds !== minBeds) return false;
                }
                if (p.price < filters.priceMin || p.price > filters.priceMax) return false;
                if (p.area < filters.areaMin || p.area > filters.areaMax) return false;
                if (filters.q && !p.title.includes(filters.q) && !p.location.includes(filters.q)) return false;
                if (filters.location && !p.locationSlug.includes(filters.location) && !p.location.includes(filters.location)) return false;
                return true;
            });

            // Sort
            properties = sortProperties(properties, sortBy);

            // Update count
            resultsCount.textContent = `تم العثور على ${properties.length} عقار`;

            // Check empty
            if (properties.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // Paginate
            const start = (currentPage - 1) * perPage;
            const paginated = properties.slice(start, start + perPage);

            // Render
            grid.innerHTML = paginated.map(prop => createPropertyCard(prop)).join('');

            // Pagination
            renderPagination(properties.length);

            // Update active filters display
            renderActiveFilters();
        }

        function sortProperties(properties, by) {
            switch (by) {
                case 'price-asc':
                    return [...properties].sort((a, b) => a.price - b.price);
                case 'price-desc':
                    return [...properties].sort((a, b) => b.price - a.price);
                case 'area-desc':
                    return [...properties].sort((a, b) => b.area - a.area);
                case 'newest':
                default:
                    return [...properties].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            }
        }

        function createPropertyCard(prop) {
            const bedsText = prop.beds > 0 ? `${prop.beds} غرف` : '-';
            const bathsText = prop.baths > 0 ? `${prop.baths} حمام` : '-';

            return `
                <article class="property-card bg-white rounded-2xl shadow-md overflow-hidden border border-gray-100 group flex flex-col h-full">
                    <a href="/pages/property.html?id=${prop.id}" class="relative block h-52 overflow-hidden">
                        <img src="${prop.image}" alt="${prop.title}" loading="lazy" class="w-full h-full object-cover group-hover:scale-105 transition duration-500">
                        <div class="absolute top-3 right-3 flex gap-2">
                            <span class="px-2 py-1 rounded-full text-xs font-bold text-white ${prop.type === 'sale' ? 'bg-green-600' : 'bg-purple-600'}">${prop.typeLabel}</span>
                            ${prop.verified ? '<span class="bg-blue-600 px-2 py-1 rounded-full text-xs font-bold text-white"><i class="fa-solid fa-check"></i></span>' : ''}
                        </div>
                    </a>
                    <div class="p-4 flex-1 flex flex-col">
                        <a href="/pages/property.html?id=${prop.id}">
                            <h3 class="font-bold text-gray-800 mb-1 line-clamp-1 group-hover:text-primary-600 transition">${prop.title}</h3>
                        </a>
                        <p class="text-gray-500 text-sm mb-3 flex items-center gap-1">
                            <i class="fa-solid fa-location-dot text-primary-500"></i> ${prop.location}
                        </p>
                        <div class="flex justify-between text-sm text-gray-600 border-t border-gray-100 pt-3 mb-3">
                            <span><i class="fa-solid fa-bed text-gray-400"></i> ${bedsText}</span>
                            <span><i class="fa-solid fa-bath text-gray-400"></i> ${bathsText}</span>
                            <span><i class="fa-solid fa-maximize text-gray-400"></i> ${prop.area} م²</span>
                        </div>
                        <div class="mt-auto">
                            <p class="text-lg font-bold text-primary-900">${prop.priceFormatted} <span class="text-sm font-normal text-gray-500">${prop.currency}</span></p>
                        </div>
                    </div>
                </article>
            `;
        }

        function renderActiveFilters() {
            const container = document.getElementById('active-filters');
            const chips = [];

            if (filters.type) chips.push({ label: filters.type === 'sale' ? 'بيع' : 'إيجار', key: 'type' });
            if (filters.propertyType) chips.push({ label: getPropertyTypeLabel(filters.propertyType), key: 'propertyType' });
            if (filters.beds) chips.push({ label: `${filters.beds}+ غرف`, key: 'beds' });
            if (filters.priceMin > 0 || filters.priceMax < Infinity) {
                const label = `${filters.priceMin.toLocaleString()} - ${filters.priceMax === Infinity ? '∞' : filters.priceMax.toLocaleString()} ج.م`;
                chips.push({ label, key: 'price' });
            }

            if (chips.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            container.innerHTML = chips.map(chip => `
                <span class="bg-primary-100 text-primary-700 px-3 py-1 rounded-full text-sm flex items-center gap-2">
                    ${chip.label}
                    <button onclick="removeFilter('${chip.key}')" class="hover:text-primary-900"><i class="fa-solid fa-xmark"></i></button>
                </span>
            `).join('');
        }

        function removeFilter(key) {
            if (key === 'price') {
                filters.priceMin = 0;
                filters.priceMax = Infinity;
                document.getElementById('price-min').value = '';
                document.getElementById('price-max').value = '';
            } else {
                filters[key] = '';
                document.querySelectorAll(`[data-filter="${key}"]`).forEach(c => c.classList.remove('active'));
            }
            renderResults();
        }

        function getPropertyTypeLabel(type) {
            const labels = { apartment: 'شقة', villa: 'فيلا', duplex: 'دوبلكس', chalet: 'شاليه', commercial: 'محل', office: 'مكتب' };
            return labels[type] || type;
        }

        function renderPagination(total) {
            const container = document.getElementById('pagination');
            const totalPages = Math.ceil(total / perPage);

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `<button onclick="goToPage(${i})" class="w-10 h-10 rounded-lg ${i === currentPage ? 'bg-primary-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} font-medium transition">${i}</button>`;
            }
            container.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            renderResults();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Search form
        document.getElementById('search-form')?.addEventListener('submit', (e) => {
            e.preventDefault();
            filters.q = document.getElementById('search-query').value;
            currentPage = 1;
            renderResults();
        });
    </script>
</body>
</html>
